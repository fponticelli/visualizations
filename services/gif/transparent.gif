<?php
require_once("ReportGrid.php");

$token      = isset($_GET['tokenId']) ? urldecode($_GET['tokenId']) : null;
$path       = isset($_GET['path'])    ? urldecode($_GET['path'])    : null;;
$event      = isset($_GET['event'])   ? urldecode($_GET['event'])   : null;;

$service    = isset($_GET['service']) ? urldecode($_GET['service']) : null;;
$rollup     = isset($_GET['rollup'])  ? urldecode($_GET['rollup'])  : null;;


function error($message)
{
	header('HTTP/1.0 400 Bad Request', true, 400);
	header('X-Error: ' . $message);
}

function ip()
{
	$headers = @apache_request_headers();
	if($headers && isset($headers['X-Forwarded-For']))
		return $headers['X-Forwarded-For'];
    return array_key_exists('HTTP_X_FORWARDED_FOR', $_SERVER)
        ? $_SERVER['HTTP_X_FORWARDED_FOR']
        : (array_key_exists('REMOTE_ADDR', $_SERVER)
        ? $_SERVER['REMOTE_ADDR']
        : null);
}

if($ip = ip()) header("X-IP: " . $ip);

if(!$token || !$path || !$event)
{
	if(!$token)
		error("request is missing the mandatory tokenId");
	else if(!$path)
		error("request is missing the mandatory path");
	else
		error("request is missing the mandatory event");
} else {
	$options = array();
	if($rollup)
	    $options['rollup'] = $rollup;

	$events = json_decode($event, true);

	$api = $service ? new ReportGridAPI($token, $service) : new ReportGridAPI($token);
	$api->forwardIP = true;
	if(!$api->track($path, $events, $options))
		error("unable to track data at $path for $token: " . json_encode($events) . " with " . $api->errorMessage);
}

header('X-Powered-By: ReportGrid');
header("Content-type: image/gif");
header("Content-length: 43");

$fp=fopen("php://output","wb");
fwrite($fp,"GIF89a\x01\x00\x01\x00\x80\x00\x00\xFF\xFF\xFF\x00\x00\x00\x21\xF9\x04\x01\x00\x00\x00\x00\x2C\x00\x00\x00\x00\x01\x00\x01\x00\x00\x02\x02\x44\x01\x00\x3B",43);
fclose($fp);